{"version":3,"mappings":"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","names":[],"ignoreList":[],"sources":["../../src/models-config.js","../../src/main.js"],"sourcesContent":["// 大模型配置文件\n\n// 模型配置和函数的聚合\n// const modelFiles = [\n//   { id: 'deepseek', json: () => import('./models/deepseek.json'), js: () => import('./models/deepseek.js') },\n//   { id: 'cozeV3', json: () => import('./models/cozeV3.json'), js: () => import('./models/cozeV3.js') },\n//   { id: 'cozeV2', json: () => import('./models/cozeV2.json'), js: () => import('./models/cozeV2.js') },\n//   { id: 'kimi-k2-0905-preview', json: () => import('./models/kimi-k2-0905-preview.json'), js: () => import('./models/kimi-k2-0905-preview.js') }\n// ];\nlet modelFiles = [\n  \"deepseek\",\n  \"cozeV3\",\n  \"cozeV2\",\n  \"kimi-k2-0905-preview\",\n].map(item => ({\n  id: item,\n  json: () => import(`./models/${item}.json`),\n  js: () => import(`./models/${item}.js`)\n}))\n\nconst kimiModelFiles = ['kimi-k2-0711-preview', 'kimi-k2-0905-preview', 'kimi-k2-turbo-preview', 'kimi-latest', 'kimi-thinking-preview', 'moonshot-v1-128k', 'moonshot-v1-128k-vision-preview', 'moonshot-v1-32k', 'moonshot-v1-32k-vision-preview', 'moonshot-v1-8k', 'moonshot-v1-8k-vision-preview', 'moonshot-v1-auto'].map(item => {\n  return {\n    id: item,\n    json: () => import(`./models/kimi-k2-0905-preview.json`),\n    js: () => import(`./models/kimi-k2-0905-preview.js`),\n    options: {\n      \"id\": item,\n      \"name\": item,\n      \"model\": item,\n    },\n  }\n})\n\nmodelFiles = modelFiles.concat(kimiModelFiles)\n\n// 动态加载所有模型配置\nlet models = [];\n\n// 初始化函数，用于异步加载所有模型\nasync function initializeModels() {\n  const loadedModels = await Promise.all(\n    modelFiles.map(async (modelFile) => {\n      try {\n        // 加载JSON配置\n        const jsonModule = await modelFile.json();\n        const config = jsonModule.default || jsonModule;\n        \n        // 加载JS函数\n        const jsModule = await modelFile.js();\n        \n        // 合并配置和函数\n        return {\n          ...config,\n          formatPayload: jsModule.formatPayload,\n          formatResponse: jsModule.formatResponse,\n          parseStreamChunk: jsModule.parseStreamChunk, // 添加流式解析函数\n          ...modelFile.options,\n        };\n      } catch (error) {\n        console.error(`Failed to load model ${modelFile.id}:`, error);\n        return null;\n      }\n    })\n  );\n  \n  // 过滤掉加载失败的模型\n  models = loadedModels.filter(model => model !== null);\n  \n  // 如果没有成功加载的模型，添加默认的deepseek模型作为备用\n  if (models.length === 0) {\n    models = [{ \n      id: 'deepseek',\n      name: 'Deepseek',\n      endpoint: 'https://api.deepseek.com/chat/completions',\n      apiKeyEnv: 'VITE_DEEPSEEK_API_KEY',\n      defaultKey: 'demo_key',\n      model: 'deepseek-chat',\n      mockEndpoint: 'http://localhost:3001/api/mock-api',\n      formatPayload: (messages, options = {}) => ({\n        \"model\": \"deepseek-chat\",\n        \"modelId\": \"deepseek\",\n        \"messages\": [\n          {\"role\": \"system\", \"content\": \"You are a helpful assistant.\"},\n          {\"role\": \"user\", \"content\": messages}\n        ],\n        \"stream\": options.stream || false,\n      }),\n      formatResponse: (data) => ({\n        context: data.choices?.[0]?.message?.content || \"\"\n      })\n    }];\n  }\n}\n\n// 初始化模型\nawait initializeModels().catch(error => {\n  console.error('Failed to initialize models:', error);\n});\n\n// 导出模型数组（提供访问接口）\nexport { models };\n\n// 中间件函数：根据模型格式化请求响应\nexport function formatResponseForModel(model, response) {\n  if (model.formatResponse && typeof model.formatResponse === 'function') {\n    return model.formatResponse(response);\n  }\n\n  return {\n    context: \"\"\n  }\n}\n\n// 中间件函数：根据模型格式化请求payload\nexport function formatPayloadForModel(model, messages, options = {}) {\n  // 默认开启流式响应\n  const stream = options.stream !== undefined ? options.stream : true;\n  \n  if (model.formatPayload && typeof model.formatPayload === 'function') {\n    return model.formatPayload(messages, { ...options, stream });\n  }\n  \n  // 默认的请求格式\n  return {\n    model: model.model,\n    messages,\n    stream\n  };\n}\n\n// 流式响应处理辅助函数\nexport async function processStreamResponse(response, callback) {\n  if (!response.body) {\n    throw new Error('Response body is not available');\n  }\n  \n  const reader = response.body.getReader();\n  const decoder = new TextDecoder();\n  let buffer = '';\n  \n  try {\n    while (true) {\n      const { done, value } = await reader.read();\n      if (done) break;\n      \n      // 解码新数据并与缓冲区合并\n      const chunk = buffer + decoder.decode(value, { stream: true });\n      const lines = chunk.split('\\n');\n      buffer = lines.pop(); // 保存不完整的行\n      \n      // 处理完整的行\n      for (const line of lines) {\n        // 跳过空行\n        if (line.trim() === '') continue;\n        \n        // 尝试多种格式解析\n        try {\n          // 格式1: 标准SSE格式 (data: JSON)\n          if (line.startsWith('data: ')) {\n            const dataPart = line.slice(6);\n            if (dataPart === '[DONE]') break;\n            \n            try {\n              const jsonData = JSON.parse(dataPart);\n              if (typeof callback === 'function') {\n                callback(jsonData);\n              }\n            } catch (jsonError) {\n              // 如果JSON解析失败，直接传递原始字符串\n              console.warn('Failed to parse JSON, passing raw string:', jsonError);\n              if (typeof callback === 'function') {\n                callback(line);\n              }\n            }\n          } \n          // 格式2: 直接传递原始数据给回调函数\n          else if (typeof callback === 'function') {\n            callback(line);\n          }\n        } catch (error) {\n          console.error('Error processing stream line:', error, 'Line:', line);\n        }\n      }\n    }\n    \n    // 处理最后的缓冲区内容\n    if (buffer.trim() && typeof callback === 'function') {\n      callback(buffer);\n    }\n  } finally {\n    reader.releaseLock();\n  }\n}\n\n// 根据模型处理流式响应数据\nexport function parseStreamChunk(model, chunk) {\n  console.log(\"chunk: \", chunk, model.parseStreamChunk)\n  if (model.parseStreamChunk && typeof model.parseStreamChunk === 'function') {\n    return model.parseStreamChunk(chunk);\n  }\n\n  \n  // 默认解析逻辑（兼容OpenAI/Deepseek格式）\n  if (chunk.choices && chunk.choices[0] && chunk.choices[0].delta) {\n    return chunk.choices[0].delta.content || '';\n  }\n  return '';\n}\n\n// 中间件函数：处理响应数据，统一格式\nexport function processResponseForModel(model, rawResponse) {\n  // 这里可以根据不同模型的响应格式进行标准化处理\n  // 目前假设所有模型都返回与OpenAI兼容的格式\n  return rawResponse;\n}\n\n// 获取默认模型\nexport function getDefaultModel() {\n  return models[0];\n}\n\n// 根据ID获取模型\nexport function getModelById(id) {\n  return models.find(model => model.id === id) || getDefaultModel();\n}\n\n// 获取当前选中的模型\nexport function getCurrentModel() {\n  const savedModelId = localStorage.getItem('selected_model');\n  console.log('savedModelId: ', savedModelId, models)\n  return savedModelId ? getModelById(savedModelId) : getDefaultModel();\n}\n\n// 设置当前选中的模型\nexport function setCurrentModel(modelId) {\n  localStorage.setItem('selected_model', modelId);\n}","import './style.css'\nimport { models, getCurrentModel, setCurrentModel, formatPayloadForModel, formatResponseForModel, processStreamResponse, parseStreamChunk } from './models-config.js'\n\n// 尝试导入模式配置（可能由启动脚本生成）\nlet modeConfig = null;\n\n// 安全的Markdown渲染函数，用于流式响应\nfunction safeMarkdownRender(text) {\n  try {\n    // 简单检查文本是否可能包含不完整的Markdown语法\n    // 这是一个基本实现，可以根据需要扩展\n    const hasUnclosedCodeBlock = (text.match(/```/g) || []).length % 2 !== 0;\n    const hasUnclosedLink = (text.match(/\\[/g) || []).length > (text.match(/\\)/g) || []).length;\n    \n    // 如果存在不完整的代码块，尝试关闭它\n    if (hasUnclosedCodeBlock) {\n      text += '\\n```';\n    }\n    \n    // 渲染Markdown\n    return marked.parse(text, {\n      breaks: true, // 将换行符转换为<br>\n      gfm: true,    // 使用GitHub风格的Markdown\n      // 禁用一些在流式渲染中可能有问题的功能\n      headerIds: false,\n      mangle: false\n    });\n  } catch (e) {\n    console.warn('Markdown渲染错误，使用纯文本:', e);\n    // 转义HTML特殊字符\n    return text\n      .replace(/&/g, '&amp;')\n      .replace(/</g, '&lt;')\n      .replace(/>/g, '&gt;')\n      .replace(/\"/g, '&quot;')\n      .replace(/'/g, '&#039;')\n      .replace(/\\n/g, '<br>');\n  }\n}\ntry {\n  // 使用动态导入避免构建错误\n  import('./mode-config.js').then(config => {\n    modeConfig = config.default || config;\n    console.log('导入的模式配置:', modeConfig);\n  }).catch(error => {\n    console.log('未找到模式配置文件，使用默认配置');\n  });\n} catch (e) {\n  console.log('导入模式配置出错:', e);\n}\n\n// 创建应用内容，支持多模型切换和流式响应\nconst app = document.getElementById('app');\napp.innerHTML = `\n  <div class=\"container\">\n    <h1>AI 对话助手</h1>\n    <div class=\"model-selector\">\n      <label for=\"model-select\">选择模型：</label>\n      <select id=\"model-select\"></select>\n    </div>\n    <div class=\"mode-switcher\">\n      <button id=\"btn-mock\" class=\"mode-btn active\">Mock模式</button>\n      <button id=\"btn-real\" class=\"mode-btn\">真实模式</button>\n    </div>\n    <div id=\"current-status\" class=\"status-info\">当前状态: Mock | Deepseek</div>\n    \n    <!-- 新增文本输入区域 -->\n    <div class=\"input-area\">\n      <textarea id=\"user-input\" placeholder=\"请输入您的问题...\"></textarea>\n      <button id=\"send-btn\" class=\"send-btn\">发送</button>\n    </div>\n    \n    <!-- 响应显示区域 -->\n    <div class=\"response-area\">\n      <h3>AI回复：</h3>\n      <div id=\"reply\" class=\"reply markdown-content\">请输入问题并发送</div>\n    </div>\n  </div>\n`;\n\n// 添加样式\nconst style = document.createElement('style');\nstyle.textContent = `\n  body {\n    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n    display: flex;\n    justify-content: center;\n    align-items: center;\n    min-height: 100vh;\n    margin: 0;\n    background-color: #f0f7ff;\n  }\n  .container {\n    text-align: center;\n    padding: 2rem;\n    background-color: white;\n    border-radius: 12px;\n    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);\n  }\n  h1 {\n    color: #3498db;\n    margin-bottom: 1.5rem;\n  }\n  .reply {\n    padding: 1rem;\n    background-color: #f8f9fa;\n    border-radius: 8px;\n    border-left: 4px solid #3498db;\n    min-height: 60px;\n    // display: flex;\n    align-items: center;\n    justify-content: center;\n    font-size: 1.1rem;\n    margin-bottom: 1rem;\n  }\n  .model-selector {\n    margin-bottom: 1rem;\n  }\n  .model-selector select {\n    padding: 0.5rem;\n    border: 1px solid #ddd;\n    border-radius: 4px;\n    font-size: 1rem;\n  }\n  .status-info {\n    margin-bottom: 1rem;\n    font-size: 0.9rem;\n    color: #666;\n  }\n  .mode-switcher {\n    display: flex;\n    justify-content: center;\n    gap: 0.5rem;\n    margin-bottom: 1rem;\n  }\n  .mode-btn {\n    padding: 0.5rem 1rem;\n    border: 1px solid #ddd;\n    background-color: #f8f9fa;\n    border-radius: 4px;\n    cursor: pointer;\n  }\n  .mode-btn.active {\n    background-color: #3498db;\n    color: white;\n    border-color: #3498db;\n  }\n  .refresh-btn {\n    padding: 0.5rem 1.5rem;\n    background-color: #2ecc71;\n    color: white;\n    border: none;\n    border-radius: 4px;\n    cursor: pointer;\n    font-size: 1rem;\n  }\n  .refresh-btn:hover {\n    background-color: #27ae60;\n  }\n  \n  /* 新增输入区域样式 */\n  .input-area {\n    margin: 1rem 0;\n    display: flex;\n    gap: 0.5rem;\n  }\n  \n  #user-input {\n    flex: 1;\n    padding: 0.8rem;\n    border: 1px solid #ddd;\n    border-radius: 4px;\n    font-size: 1rem;\n    resize: vertical;\n    min-height: 60px;\n  }\n  \n  .send-btn {\n    padding: 0.8rem 1.5rem;\n    background-color: #3498db;\n    color: white;\n    border: none;\n    border-radius: 4px;\n    cursor: pointer;\n    font-size: 1rem;\n    white-space: nowrap;\n  }\n  \n  .send-btn:hover {\n    background-color: #2980b9;\n  }\n  \n  .send-btn:disabled {\n    background-color: #95a5a6;\n    cursor: not-allowed;\n  }\n  \n  .response-area {\n    margin-top: 1rem;\n    text-align: left;\n  }\n  \n  .response-area h3 {\n    margin: 0 0 0.5rem 0;\n    color: #333;\n    font-size: 1.1rem;\n  }\n  \n  .reply {\n    padding: 1rem;\n    background-color: #f8f9fa;\n    border-radius: 8px;\n    border-left: 4px solid #3498db;\n    min-height: 60px;\n    line-height: 1.6;\n  }\n`;\ndocument.head.appendChild(style);\n\n// 检查是否为mock模式\nfunction isMockMode() {\n  try {\n    // 1. 首先检查localStorage（由用户手动切换按钮设置，最高优先级）\n    const localStorageMode = localStorage.getItem('app_mode');\n    if (localStorageMode === 'mock' || localStorageMode === 'real') {\n      const isMock = localStorageMode === 'mock';\n      console.log(`LocalStorage模式: ${isMock ? 'mock' : '真实'}`);\n      return isMock;\n    }\n    \n    // 2. 检查URL参数\n    const urlParams = new URLSearchParams(window.location.search);\n    const mockParam = urlParams.get('mock');\n    if (mockParam !== null) {\n      const isMock = mockParam === 'true';\n      console.log(`URL参数模式: ${isMock ? 'mock' : '真实'}`);\n      return isMock;\n    }\n    \n    // 3. 检查modeConfig（由启动脚本生成）\n    if (modeConfig && modeConfig.app_mode) {\n      const isMock = modeConfig.app_mode === 'mock';\n      console.log(`配置文件模式: ${isMock ? 'mock' : '真实'}`);\n      return isMock;\n    }\n    \n    // 4. 检查环境变量（在浏览器环境中通过import.meta.env获取）\n    const isEnvMock = import.meta.env?.NODE_ENV === 'mock';\n    const isEnvReal = import.meta.env?.NODE_ENV === 'real';\n    if (isEnvMock || isEnvReal) {\n      const isMock = isEnvMock;\n      console.log(`环境变量模式: ${isMock ? 'mock' : '真实'}`);\n      return isMock;\n    }\n    \n    // 5. 默认模式（为了安全默认使用mock模式）\n    console.log('默认模式: mock');\n    return true;\n  } catch (e) {\n    console.error('检查mock模式出错:', e);\n    return true;\n  }\n}\n\n// 设置当前模式\nfunction setMode(isMock) {\n  localStorage.setItem('app_mode', isMock ? 'mock' : 'real');\n  \n  // 更新UI\n  document.getElementById('btn-mock').classList.toggle('active', isMock);\n  document.getElementById('btn-real').classList.toggle('active', !isMock);\n  updateStatusDisplay(isMock);\n  \n  console.log(`模式已切换为: ${isMock ? 'mock' : 'real'}`);\n}\n\n// 更新状态显示\nfunction updateStatusDisplay(isMock = null) {\n  const currentIsMock = isMock !== null ? isMock : isMockMode();\n  const currentModel = getCurrentModel();\n  document.getElementById('current-status').textContent = `当前状态: ${currentIsMock ? 'Mock' : '真实'} | ${currentModel.name}`;\n}\n\n// 初始化模型选择器\nfunction initModelSelector() {\n  const modelSelect = document.getElementById('model-select');\n  const currentModel = getCurrentModel();\n  \n  // 添加所有模型选项\n  models.forEach(model => {\n    const option = document.createElement('option');\n    option.value = model.id;\n    option.textContent = model.name;\n    option.selected = model.id === currentModel.id;\n    modelSelect.appendChild(option);\n  });\n  \n  // 添加事件监听器\n  modelSelect.addEventListener('change', (event) => {\n    const selectedModelId = event.target.value;\n    setCurrentModel(selectedModelId);\n    updateStatusDisplay();\n    fetchResponse(); // 切换模型后重新获取响应\n  });\n}\n\n// 初始化应用\nfunction initApp() {\n  const btnMock = document.getElementById('btn-mock');\n  const btnReal = document.getElementById('btn-real');\n  const refreshBtn = document.getElementById('refresh-btn');\n  \n  // 初始化模型选择器\n  initModelSelector();\n  \n  // 初始状态\n  const initialMode = isMockMode();\n  setMode(initialMode);\n  \n  // 添加事件监听器\n  btnMock.addEventListener('click', () => {\n    setMode(true);\n  });\n  \n  btnReal.addEventListener('click', () => {\n    setMode(false);\n  });\n  \n  // 添加发送按钮事件监听器\n  const sendBtn = document.getElementById('send-btn');\n  const userInput = document.getElementById('user-input');\n  \n  sendBtn.addEventListener('click', () => {\n    sendMessage();\n  });\n  \n  // 添加回车键发送功能\n  userInput.addEventListener('keydown', (event) => {\n    if (event.key === 'Enter' && !event.shiftKey) {\n      event.preventDefault();\n      sendMessage();\n    }\n  });\n}\n\n// 发送消息函数\nasync function sendMessage() {\n  const userInput = document.getElementById('user-input');\n  const message = userInput.value.trim();\n  \n  if (!message) {\n    alert('请输入问题');\n    return;\n  }\n  \n  const sendBtn = document.getElementById('send-btn');\n  sendBtn.disabled = true;\n  \n  try {\n    await fetchResponse(message);\n  } finally {\n    sendBtn.disabled = false;\n  }\n}\n\n// 保存响应到文件的函数（仅在非mock模式下执行）\nasync function saveResponseToFile(responseData, message) {\n  // 在mock模式下不保存响应\n  if (isMockMode()) {\n    console.log('Mock模式下，不保存响应到文件');\n    return;\n  }\n  \n  const currentModel = getCurrentModel();\n  const payload = currentModel.formatPayload(message);\n  \n  // 准备要保存的数据，包括响应和元信息\n  const saveData = {\n    timestamp: new Date().toISOString(),\n    model: currentModel.id,\n    modelName: currentModel.name,\n    response: responseData,\n    request: payload,\n    message: message,\n  };\n  \n  try {\n    // 调用后端API保存文件\n    const response = await fetch('http://localhost:3001/api/save-chat', {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json'\n      },\n      body: JSON.stringify(saveData)\n    });\n    \n    const result = await response.json();\n    \n    if (result.success) {\n      console.log(result.message);\n      // 可以在这里添加成功提示给用户\n    } else {\n      console.error('保存失败:', result.message);\n    }\n  } catch (error) {\n    console.error('保存文件时发生错误:', error);\n    \n    // 降级处理：如果后端服务不可用，退回到浏览器下载方式\n    // fallbackToBrowserDownload(saveData);\n  }\n}\n\n// 降级处理：浏览器下载方式\nfunction fallbackToBrowserDownload(saveData) {\n  const timestamp = new Date().toISOString().replace(/[:.]/g, '-');\n  const modelId = saveData.model || 'unknown';\n  const fileName = `${timestamp}-${modelId}-response.json`;\n  \n  const blob = new Blob([JSON.stringify(saveData, null, 2)], { type: 'application/json' });\n  const link = document.createElement('a');\n  link.href = URL.createObjectURL(blob);\n  link.download = fileName;\n  \n  document.body.appendChild(link);\n  link.click();\n  \n  document.body.removeChild(link);\n  URL.revokeObjectURL(link.href);\n  \n  console.log(`由于后端服务不可用，响应已保存为 ${fileName}（下载到您的默认下载文件夹）`);\n}\n\n// 通用模型API调用代码，支持流式响应\nasync function fetchModelResponse(message, onStreamChunk) {\n  const mockMode = isMockMode();\n  const currentModel = getCurrentModel();\n  console.log(`当前模型: ${currentModel.name}, 模式: ${mockMode ? 'Mock' : '真实'}`);\n  \n  try {\n    let response;\n    \n    // 准备请求参数\n    const options = {\n      stream: true,\n      isMock: mockMode\n    };\n    \n    // 使用中间件函数格式化请求payload\n    const payload = formatPayloadForModel(currentModel, message, options);\n    \n    if (mockMode) {\n      // Mock模式：调用模拟API\n      console.log(`使用${currentModel.name}的Mock API`, JSON.stringify(payload, null, 2));\n      \n      response = await fetch(currentModel.mockEndpoint, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json'\n        },\n        body: JSON.stringify(payload.model ? payload : {\n          ...payload,\n          model: currentModel.id,\n        })\n      });\n    } else {\n      // 真实模式：调用真实API\n      console.log(`使用${currentModel.name}的真实API`);\n      // 获取API密钥\n      const apiKey = import.meta.env[currentModel.apiKeyEnv] || currentModel.defaultKey;\n      \n      const headers = {\n        'Content-Type': 'application/json',\n        Authorization: `Bearer ${apiKey}`\n      };\n\n      console.log(`发送到${currentModel.name}的请求格式:`, JSON.stringify(payload, null, 2));\n      \n      response = await fetch(currentModel.endpoint, {\n        method: 'POST',\n        headers: headers,\n        body: JSON.stringify(payload.model ? payload : {\n          ...payload,\n          model: currentModel.id,\n        })\n      });\n    }\n\n    if (!response.ok) {\n      throw new Error(`${mockMode ? '模拟' : '真实'}API错误: ${response.status}`);\n    }\n\n    // 如果需要流式处理\n    console.log(\"payload.stream && onStreamChunk\", payload.stream, onStreamChunk, response)\n    if (payload.stream && onStreamChunk) {\n      let fullResponse = '';\n      \n      // 使用流式处理函数\n      await processStreamResponse(response, (chunk) => {\n        const textChunk = parseStreamChunk(currentModel, chunk);\n        fullResponse += textChunk;\n        onStreamChunk(textChunk, chunk);\n      });\n      \n      return {\n        response: fullResponse,\n        data: { context: fullResponse }\n      };\n    } else {\n      // 非流式处理（降级方案）\n      const data = await response.json();\n      const assistantReply = formatResponseForModel(currentModel, data);\n      return {\n        response: data,\n        data: assistantReply,\n      };\n    }\n  } catch (error) {\n    console.error(`${mockMode ? '获取模拟' : '获取真实'}${currentModel.name}响应失败:`, error);\n    \n    // 使用模拟数据作为降级方案\n    const fallbackReply = `⚫ 这是一条${mockMode ? '模拟' : '测试'}响应数据（${currentModel.name}）\n\n错误信息: ${error.message}`;\n    \n    // 不在这里设置UI，让调用者来处理\n    return {\n      response: null,\n      data: {\n        context: fallbackReply,\n      }\n    };\n  }\n}\n\n// 获取响应的主函数，支持流式显示\nasync function fetchResponse(message) {\n  const replyElement = document.getElementById('reply');\n    replyElement.classList.add('markdown-content');\n    replyElement.textContent = '正在生成回复...';\n  \n  // 更新状态显示\n  updateStatusDisplay();\n\n  try {\n    let fullResponse = '';\n    let streamEnded = false;\n    let lastResponseTime = Date.now();\n    let fullRawResponse = null;\n    \n    // 处理流式响应的回调函数\n    const onStreamChunk = (textChunk, rawChunk) => {\n      if (textChunk) {\n        fullResponse += textChunk;\n        // 添加markdown-content类以应用样式\n        replyElement.classList.add('markdown-content');\n        // 使用安全的Markdown渲染函数\n        replyElement.innerHTML = safeMarkdownRender(fullResponse);\n        lastResponseTime = Date.now();\n      }\n      \n      // 保存最后一个原始响应块用于保存\n      if (rawChunk) {\n        fullRawResponse = rawChunk;\n      }\n    };\n    \n    // 开始获取响应\n    const responsePromise = fetchModelResponse(message, onStreamChunk);\n    \n    // 添加超时检测\n    const checkTimeout = setInterval(() => {\n      if (Date.now() - lastResponseTime > 30000) { // 30秒无响应认为超时\n        replyElement.textContent += '\\n\\n⚠️ 响应超时，可能已断开连接。';\n        streamEnded = true;\n        clearInterval(checkTimeout);\n      }\n    }, 1000);\n    \n    // 等待响应完成\n    const finalResponse = await responsePromise;\n    streamEnded = true;\n    clearInterval(checkTimeout);\n    \n    // 更新最终响应，确保Markdown渲染\n    replyElement.classList.add('markdown-content');\n    replyElement.innerHTML = safeMarkdownRender(finalResponse.data.context);\n    \n    // 保存响应到文件（仅在非mock模式下）\n    const isMock = isMockMode();\n    if (!isMock && !finalResponse.data.context.startsWith('⚫')) {\n      await saveResponseToFile(fullRawResponse || finalResponse.response, message);\n    }\n  } catch (error) {\n    console.error('获取响应失败:', error);\n    replyElement.innerHTML = safeMarkdownRender(`获取响应失败: ${error.message}`);\n  }\n}\n\n// 初始化应用\ninitApp();\n"],"file":"assets/index-BbMtGUB5.js"}